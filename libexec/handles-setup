#!/bin/bash
# Usage: handles-setup
# Summary: Set up the project to run for the first time

set -e
cd "$(git rev-parse --show-toplevel)"

handles-bootstrap

if [ -f ".env.example" ]; then
  echo "==> Copying environment file…"
  cp .env.example .env
fi

if [ -f "nginx.conf" ] && [ "$(uname -s)" = "Darwin" ]; then
  echo "==> Symlinking nginx server configuration file…"
  ln -sf nginx.conf "$(brew --prefix)/etc/nginx/servers/$(basename $PWD).conf"
  if ! brew services restart nginx &>/dev/null; then
    echo "!!! Error: failed to (re)start nginx!" >&2
    exit 1
  fi

  if [ "$(readlink /etc/resolver 2>/dev/null)" != "$(brew --prefix)/etc/resolver" ]; then
    echo "==> Resolving *.dev to 127.0.0.1…"
    sudo -p "Please enter your password (for sudo access):" true
    sudo ln -s $(brew --prefix)/etc/resolver /etc
  fi
fi

echo "==> Your project is now ready to go!"
