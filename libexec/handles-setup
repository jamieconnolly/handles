#!/bin/bash
# Usage: handles-setup
# Summary: Set up the project to run for the first time

set -e
cd "$(git rev-parse --show-toplevel)"
test -f "bin/setup" && exec "bin/setup" "$@"

handles-bootstrap

if [ "$(uname -s)" = "Darwin" ]; then
  PREFIX="$(brew --prefix)"
fi

PROJECT_NAME="$(echo $PWD | sed -e "s:^${PROJECTS_HOME}\\(/${GITHUB_USER}\\)\{0,1\}/\{0,1\}::g;s:\/:-:g")"

export LOG_DIR="${PREFIX}/var/log"
export PROJECT_DIR="$PWD"
export SOCKET_DIR="${PREFIX}/var/run"

if [ -f ".env.example" ]; then
  echo "==> Generating environment file…"
  handles-setup-dotenv
fi

if [ -f "nginx.conf.erb" ] && [ "$(uname -s)" = "Darwin" ]; then
  export NGINX_LOG_DIR="${LOG_DIR}/nginx"

  echo "==> Generating nginx server configuration file…"
  handles-setup-nginx-conf $PROJECT_NAME
fi

echo "==> Your project is now ready to go!"
